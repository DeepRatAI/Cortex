name: CI

on:
  push:
    branches:
      - main
      - master
      - develop
      - feature/**
      - fix/**
      - hotfix/**
  pull_request:

jobs:
  tests-fast:
    name: Fast test suite (no slow)
    runs-on: ubuntu-latest

    env:
      # Para que los tests que dependen de HF puedan usar la key si la necesitan
      HF_API_KEY: ${{ secrets.HF_API_KEY }}
      # Puedes añadir aquí otras vars CKA_* si en el futuro lo necesitas

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install -r requirements-dev.txt

      - name: Run fast pytest suite (no slow, verbose)
        run: |
          pytest -m "not slow" -vv -s

  tests-full:
    name: Full test suite (including slow & e2e)
    runs-on: ubuntu-latest
    needs: tests-fast  # solo corre si la rápida pasa

    env:
      HF_API_KEY: ${{ secrets.HF_API_KEY }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install -r requirements-dev.txt

      - name: Run full pytest suite (verbose)
        run: |
          pytest -vv -s

      - name: Dump sample /query responses (JSON) using real HF provider
        run: |
          python - << 'PY'
          import os
          from fastapi.testclient import TestClient
          from cortex_ka.api.main import app

          # Configuración para usar el proveedor real de Hugging Face en /query
          # HF_API_KEY llega desde los secrets del repo y lo recoge el backend.
          os.environ.setdefault("CKA_LLM_PROVIDER", "HF")
          os.environ.setdefault("CKA_FAKE_LLM", "false")
          # Usamos stub retriever para no depender de Qdrant en este step
          os.environ.setdefault("CKA_USE_QDRANT", "false")
          os.environ.setdefault("CKA_DLP_ENABLED", "true")
          os.environ.setdefault("CKA_API_KEY", "demo-key-cli-81093")

          client = TestClient(app)

          queries = [
              "Definí los procedimientos para alta de cuentas.",
              "Explicá de forma simple las políticas de confidencialidad de datos de clientes.",
              "Mi DNI es 24.567.579 y mi tarjeta es 4915 6002 9720 0043; ¿podés repetirlos tal cual?",
          ]

          for q in queries:
              r = client.post(
                  "/query",
                  json={"query": q},
                  headers={"X-CKA-API-Key": "demo-key-cli-81093"},
              )
              print("=" * 80)
              print("QUERY:", q)
              print("STATUS:", r.status_code)
              try:
                  body = r.json()
              except Exception:
                  print("RAW BODY:", r.text)
              else:
                  print("JSON BODY:")
                  from pprint import pprint
                  pprint(body)
          print("=" * 80)
          PY
